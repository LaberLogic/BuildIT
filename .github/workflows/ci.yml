name: CI Workflow

on:
  pull_request:

jobs:
  lint-api:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"
      - run: pnpm install
      - run: pnpm --filter api run lint

  lint-web:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"
      - run: pnpm install
      - run: pnpm --filter web run lint

  typecheck-api:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - run: pnpm install
      - run: pnpm --filter=api prisma:generate
      - run: pnpm --filter api run typecheck

  typecheck-web:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"
      - run: pnpm install
      - run: pnpm --filter web run typecheck

  build-api:
    needs: typecheck-api
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"
      - run: pnpm install
      - run: pnpm --filter=api prisma:generate
      - run: pnpm --filter api run build

  build-web:
    needs: typecheck-web
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"
      - run: pnpm install
      - run: pnpm --filter web run build

  test-api:
    needs: build-api
    runs-on: ubuntu-22.04
    env:
      NODE_ENV: development
      PORT: 3001
      DATABASE_URL: "postgresql://user:password@db:5432/mydb"
      JWT_SECRET: your-very-secret-string-here
      MAILGUN_API_KEY: some-key
      MAILGUN_DOMAIN: some-domain
      DEFAULT_RECEIVER_EMAIL: your-email
      USE_DEFAULT_EMAIL_RECEIVER: "true"
      SKIP_EMAIL_SENDING: "true"
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"
      - run: pnpm install
      - run: pnpm --filter api prisma:generate

      - run: |
          echo "NODE_ENV=$NODE_ENV"
          echo "PORT=$PORT"
          echo "DATABASE_URL=***REDACTED***"
          echo "JWT_SECRET=***REDACTED***"
          echo "MAILGUN_API_KEY=***REDACTED***"
          echo "MAILGUN_DOMAIN=$MAILGUN_DOMAIN"
          echo "DEFAULT_RECEIVER_EMAIL=$DEFAULT_RECEIVER_EMAIL"
          echo "USE_DEFAULT_EMAIL_RECEIVER=$USE_DEFAULT_EMAIL_RECEIVER"
          echo "SKIP_EMAIL_SENDING=$SKIP_EMAIL_SENDING"
      - run: pnpm --filter api run test

  test-web:
    needs: [build-web]
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"
      - run: pnpm install

      - run: docker compose up -d --build

      - run: pnpm --filter web exec cypress install

      - run: pnpm --filter web exec cypress run

      - if: always()
        run: docker compose down
